<div class="timeline-viewer-container" {{#if selectedTimeline.backgroundImage}}style="background-image: radial-gradient(circle, rgba(255, 255, 255, 0.15) 1px, transparent 1px), url('{{selectedTimeline.backgroundImage}}'); background-size: 20px 20px, cover; background-position: 0 0, center; background-color: #1a1a1a;"{{/if}}>
  <!-- SVG Filter for Rough/Ink line style -->
  <svg style="position:absolute;width:0;height:0;pointer-events:none;">
    <filter id="tl-rough-filter">
      <feTurbulence type="turbulence" baseFrequency="0.04" numOctaves="4" seed="2" result="noise"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="4" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>
  
  {{#if hasTimelines}}
  <!-- Navigation Tabs -->
  <nav class="timeline-tabs">
    {{#each timelines}}
    <button type="button"
            class="timeline-tab {{#if (eq this.id ../selectedTimeline.id)}}active{{/if}}"
            data-action="selectTimeline"
            data-timeline-id="{{this.id}}">
      {{this.name}}
    </button>
    {{/each}}
  </nav>

  <!-- Tag Filters (Left Floating Menu) -->
  <div class="timeline-filter-menu">
    
    {{#if allTags.length}}
    <div class="filter-group">
      <!-- Round Icon -->
      <div class="filter-icon-btn {{#if hasActiveFilters}}active{{/if}}">
        <i class="fa-solid fa-filter"></i>
      </div>
      
      <!-- Dropdown List (Appears on Hover) -->
      <div class="filter-dropdown">
        {{#each allTags}}
        <span class="filter-tag-chip {{#if this.active}}on{{else}}off{{/if}}"
              style="{{this.glassStyle}}"
              data-action="toggleTagFilter"
              data-tag-id="{{this.id}}">
          {{this.label}}
        </span>
        {{/each}}

        {{#if hasActiveFilters}}
        <button type="button" class="filter-clear-btn" data-action="clearFilters">
          <i class="fa-solid fa-times"></i> Clear Filters
        </button>
        {{/if}}
      </div>
    </div>
    {{/if}}

    <!-- Text Filter (Timeframe) -->
    <div class="filter-group">
      <div class="filter-icon-btn {{#if textFilter}}active{{/if}}">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="filter-dropdown">
        <div class="search-wrapper">
          <input type="text" class="filter-search-input" 
                 placeholder="Filter by timeframe..." 
                 value="{{textFilter}}">
          <i class="fa-solid fa-times search-clear-btn" style="{{#unless textFilter}}display:none;{{/unless}}"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Horizontal Timeline Content -->
  <div class="timeline-scroll-area" id="timelineScrollContainer" style="{{#if selectedTimeline.backgroundImage}}background-image: radial-gradient(circle, rgba(255, 255, 255, 0.15) 1px, transparent 1px), url('{{selectedTimeline.backgroundImage}}'); background-size: 20px 20px, cover; background-position: 0 0, center;{{/if}}">
    {{#if selectedTimeline}}
      {{#if selectedTimeline.entries.length}}
      <div class="timeline-track {{#if (eq selectedTimeline.lineStyle 'dashed')}}track-style-dashed{{/if}} {{#if (eq selectedTimeline.lineStyle 'rough')}}track-style-rough{{/if}} {{#if (eq selectedTimeline.lineEffect 'pulse')}}track-effect-pulse{{/if}} {{#if (eq selectedTimeline.lineEffect 'glitch')}}track-effect-glitch{{/if}} {{#if (eq selectedTimeline.lineEffect 'neon')}}track-effect-neon{{/if}} {{#if (eq selectedTimeline.lineEffect 'chroma')}}track-effect-chroma{{/if}} {{#if (ne selectedTimeline.dotShape 'default')}}dot-shape-{{selectedTimeline.dotShape}}{{/if}}" style="margin-top: 0; margin-bottom: 0; {{#if selectedTimeline.lineWidth}}--tl-line-width: {{selectedTimeline.lineWidth}}px;{{/if}}{{#if selectedTimeline.lineColor}}--tl-line-color: {{selectedTimeline.lineColor}};{{/if}}{{#if selectedTimeline.dotSize}}--tl-dot-size: {{selectedTimeline.dotSize}}px;{{/if}}">
        <!-- The central line -->
        <div class="track-line {{#if (eq selectedTimeline.lineStyle 'dashed')}}line-style-dashed{{/if}} {{#if (eq selectedTimeline.lineStyle 'rough')}}line-style-rough{{/if}} {{#if (eq selectedTimeline.lineEffect 'flow')}}line-effect-flow{{/if}} {{#if (eq selectedTimeline.lineEffect 'pulse')}}line-effect-pulse{{/if}} {{#if (eq selectedTimeline.lineEffect 'glitch')}}line-effect-glitch{{/if}} {{#if (eq selectedTimeline.lineEffect 'neon')}}line-effect-neon{{/if}} {{#if (eq selectedTimeline.lineEffect 'chroma')}}line-effect-chroma{{/if}}"
             ></div>

        {{#each selectedTimeline.entries}}
        <!-- Entry Block -->
        <div class="h-entry {{#if this.hidden}}hidden-entry{{/if}} {{#if this.hasMystery}}mystery-entry{{/if}} {{#if this.displayEffect}}effect-{{this.displayEffect}}{{/if}} {{#if this.isFilteredOut}}filtered-out{{/if}}"
             style="{{#if this.displayColor}}--entry-color: {{this.displayColor}};{{/if}}{{#if this.displayEffectColor}}--effect-color: {{this.displayEffectColor}};{{/if}}"
             data-period="{{this.period}}"
             data-tag-ids="{{this.tagIds}}">

          {{!-- Timeframe --}}
          {{#if this.mysteryTimeframe}}
          <span class="entry-date mystery-redacted">???</span>
          {{else if this.period}}
          <span class="entry-date">
            {{#if this.mystery.timeframe}}<i class="fa-solid fa-mask" style="font-size: 10px; color: #a855f7; margin-right: 4px;" title="Mystery"></i>{{/if}}
            {{this.period}}
          </span>
          {{/if}}

          {{!-- Card Content --}}
          <div class="card-box {{#if this.mysteryText}}mystery-text{{/if}}">
            {{#if this.mysteryText}}
            <h3 class="card-title mystery-redacted">
              <span class="mystery-placeholder">???</span>
            </h3>
            {{else}}
            <h3 class="card-title">
               {{#if this.hidden}}<i class="fa-solid fa-eye-slash hidden-icon" title="Hidden from players"></i>{{/if}}
               {{#if this.mystery.text}}<i class="fa-solid fa-mask hidden-icon mystery-icon" title="Mystery: text"></i>{{/if}}
               {{#if this.icon}}<i class="{{this.icon}} entry-icon-display"></i>{{/if}}
               {{this.name}}
               {{#if this.pageUuid}}<span class="card-page-link" data-action="openLinkedPage" data-page-uuid="{{this.pageUuid}}" title="{{this.pageName}}"><i class="fa-solid fa-file-lines"></i></span>{{/if}}
            </h3>

            <div class="card-body">
            {{#if this.description}}
            <p class="card-desc">{{this.description}}</p>
            {{/if}}

            {{#if this.tags.length}}
            <div class="card-tags">
              {{#each this.tags}}
              <span class="tag-pill" style="{{this.style}}">{{this.label}}</span>
              {{/each}}
            </div>
            {{/if}}
            </div>
            {{/if}}

          </div>


          {{!-- Image --}}
          {{#if this.mysteryImg}}
          <div class="card-img-wrapper detached">
            <div class="card-img-frame">
              <img src="modules/timeline-builder/assets/images/mystery.webp" class="card-img" alt="Mystery"
                   style="object-position: center;"
                   loading="lazy">
            </div>
          </div>
          {{else if this.img}}
          <div class="card-img-wrapper detached">
            <div class="card-img-frame">
              {{#if this.mystery.img}}<div class="mystery-img-overlay"><i class="fa-solid fa-mask"></i></div>{{/if}}
              <img src="{{this.img}}" class="card-img" alt="{{this.name}}"
                   style="object-position: {{#if this.imgPosition}}{{this.imgPosition.x}}% {{this.imgPosition.y}}%{{else}}center{{/if}};"
                   loading="lazy">
            </div>
          </div>
          {{/if}}
        </div>
        {{/each}}
      </div>
      {{else}}
        <p class="no-entries">This timeline is empty.</p>
      {{/if}}
    {{else}}
      <div class="no-timelines-viewer">
         <p>Select a timeline.</p>
      </div>
    {{/if}}
  </div>

  {{else}}
  <div class="no-timelines-viewer">
    <img src="modules/timeline-builder/assets/images/avatar.webp" class="home-illustration">
    <p>No timeline available.</p>
  </div>
  {{/if}}
</div>